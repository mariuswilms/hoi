  _   _   _
 / \ / \ / \
( H | O | I )
 \_/ \_/ \_/

---- Bare Metal PaaS


Synopsis
--------
Hoi has been created to ease hosting of the growing number
of Atelier Disko client projects.

"It's as complicated as you want it to be." [0]

Atelier Disko isn't primarly an infrastructure company, so we don't
like to afford maintaining too ambitious solutions. Resources
freed from deliberately choosing a classic shared hosting
architechture are re-invested into providing a stable, secure
and performant hosting environment with good resource utilization.

Our projects are primarly PHP-based web applications. They
are distinct in what they do but pretty uniform in how the are
structured and in the technology they need.

[0] https://twitter.com/alexander_h/status/751470506503798784

-- Hoi is currently in development and until it reaches 1.0, it --
-- should be considered not ready for general production use.   --

Is it for you?
--------------
If your hosting needs are similar and are ready to sacrifice the
benefits of i.e. containers for ease of use or you are running
services that are not well suited for per-project containers
(i.e. PHP FPM or MySQL), hoi might also be something for you.

What's inside?
--------------
Hoi consist of a server (hoid) backend and client (hoictl) to
control the server. It features several modules ("runners") which
take care of serving your project, backing it up and managing
cron jobs and workers.

Hoi currently relies on a fixed set of technologies (see requirements)
to do its job. However, changing this and implementing an abstraction
layer with adapters are a possible future goal.

The currently available runners are:
- "web"
  Sets up NGINX(8) and PHP-FPM as the application server
  when needed.

- "PHP"
  Safely enables project specific PHP(1) settings. This by
  default includes security related settings like open_basedir.
  Other alternative/classic approaches have been proven to be
  inflexible or are even buggy[0].

- "cron"
  Starts cron jobs using systemd(1) timers and will randomize
  startups to reduce resource congestion.

- "worker"
  Starts long running worker processes using systemd(1). Uses
  resource controls (i.e. MemoryMax) to keep resource
  usage of processes inside reasonable bounds. This is especially
  useful if processes are leaking memory or otherwise don't
  behave well. A feature desperately missing from alternatives
  like supervisord.

- "database"
  Creates databases and users with minimum set of privileges
  if they do not exist for mysqld(8).

Planned runners are:
- "backup"
  Uses rsnapshot(1) to produce daily/weekly/monthly backups from your
  project directory. If available will also include a dump of
  attached databases. Generated snapshots may be pushed offsite
  via SSH.

- "seal"
  Uses the mtree(8) utility to generate so called manifests of your
  projects contents and will regularly check the project against
  that manifest to detect possible tampering.

- "log"

[0] https://bugs.php.net/bug.php?id=63965
    - "php-fpm site specific settings go global"


Installation
============
Ensure GOPATH is set and get the source from GitHub.
$ go get github.com/atelierdisko/hoi

Then execute make to install configuration and binaries. The default
prefix is /usr/local. The prefix can be cahnged via the PREFIX var.
Following example code assumes no prefix at all.
$ cd $GOPATH/src/github.com/atelierdisko/hoi
$ PREFIX= make install

A system file is available in the conf/ directory, but will not be installed by
default. The following commands will do this for you.
$ cp conf/hoid.service /etc/systemd/system/
$ systemctl enable --now hoid

If you prefer to manually start the daemon (for debugging purposes) simply
call it like this:
$ hoid


Development
===========
To start hoi in a test environment execute and read
instructions printed by `make test`.
$ make test


Project Configuration: The Hoifile
==================================
https://godoc.org/github.com/atelierdisko/hoi/project

The Hoifile is a per project configuration file which defines
the needs of a project, so hoi can run it. It uses a directive
based configuration syntax similar to the NGINX configuration.

Hoi will augment a Hoifile automatically by discovering needs
of your project (i.e. does it use PHP?).

To load a project containing a Hoifile use:
$ hoictl --project=/var/www/foo load

Domain Directive
----------------
https://godoc.org/github.com/atelierdisko/hoi/project#DomainDirective

Domains are configured using the naked domain. Handling
of the www. prefix can be controlled via the "www" option.
By default the prefix is dropped.

domain example.org {} // required naked domain name/FQDN

domain example.org {
	www = "drop" // optional, either "drop", "add" or "keep"
}

A domain can have one or multiple aliases which inherit any configuration
from the domain. If your alias needs different configuration add it as an
additional domain.

domain example.org {
	aliases = ["example.com", "example.eu"]
}

You can also dynamically add an alias to a domain via hoictl:
$ hoictl domain example.org --alias=example.com

SSL Directive
.............
https://godoc.org/github.com/atelierdisko/hoi/project#SSLDirective

SSL can be enabled as follows, certificate files should
be named after the domain. Symlinks are possible too.
Once SSL is enabled all non SSL traffic will be redirected.

domain example.org {
	ssl = {
		certificate = "config/ssl/example.com.crt"
		certificateKey =  "config/ssl/example.com.key"
	}
}

Auth Directive
..............
https://godoc.org/github.com/atelierdisko/hoi/project#AuthDirective

Access protection via auth - especially useful for staging/preview
contexts - can be enabled as follows:

domain example.org {
	auth = {
		user = "foo" // optional, defaults to project name
		password = "bar" // required, must be non empty
	}
}

Cron Directive
--------------
https://godoc.org/github.com/atelierdisko/hoi/project#CronDirective

Jobs that are run on a regular basis are configured via the cron
directive. The schedule option supports expressions from
systemd.time like "daily", "hourly", "weekly".

cron low-freq { // optional identifier
	schedule = "daily"
	command = "bin/li3 calculate-stock"
}

Database Directive
------------------
https://godoc.org/github.com/atelierdisko/hoi/project#DatabaseDirective

Hoi can manage the database creation and users for you. It will create
a database if it does not exist (the rest is left to migration tools).
It will also create a user or ensure an existing user has a minimal
set of privileges to access that database.

database foo { // optional database name
	user = "foo" // optional user name, defaults to project name
	password = "s3cret"
}


Server Configuration: hoid.conf
===============================
https://godoc.org/github.com/atelierdisko/hoi/server

Customizing Service Templates
-----------------------------
The templates used by hoid to generate service configuration can
be customized, they reside inside and use Go Template[0] syntax.
/etc/hoi/templates

[0] https://golang.org/pkg/text/template/


Copyright & License
===================
Hoi is Copyright (c) 2016 Atelier Disko if not otherwise
stated. Use of the source code is governed by a BSD-style
license that can be found in the LICENSE file.


Versions & Requirements
=======================
The Go language >= 1.6 is required to build the project.

Hoi is continously tested on Linux and Darwin.

The web runner requires nginx(8)
  The default template for NGINX will log to syslog/journald. This
  feature is available in NGINX >= 1.7.1. To lower this version
  requirement the "useLegacy" option can be enabled (which will
  log to STDERR instead).

The cron runner requires systemd(1)
The worker runner requires systemd(1)
  Recent systemd versions are always supported, older ones (i.e. 215)
  are probably supported via the "useLegacy" option.

The PHP runner requires PHP(1)
  If you don't enable this runner you can drop this requirement.
